cmake_minimum_required(VERSION 3.20)

project(UniDictCore
    VERSION 1.0.0
    DESCRIPTION "UniDict Core Library"
    LANGUAGES CXX
)

# 设置编译选项
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 查找依赖
find_package(ZLIB REQUIRED)

# 获取所有源文件
file(GLOB_RECURSE CORE_STD_SOURCES "std/*.cpp")
file(GLOB_RECURSE CORE_STD_HEADERS "std/*.h")

# 过滤掉不需要的文件（如果有的话）
list(FILTER CORE_STD_SOURCES EXCLUDE REGEX ".*test.*")

# 创建STD-only索引引擎库
add_library(unidict_index_std STATIC
    std/index_engine_std.cpp
)

target_include_directories(unidict_index_std PUBLIC
    "${CMAKE_CURRENT_SOURCE_DIR}"
    "${CMAKE_CURRENT_SOURCE_DIR}/std"
)

# 创建STD-only核心库
add_library(unidict_std_core STATIC
    std/path_utils_std.cpp
    std/data_store_std.cpp
    std/json_parser_std.cpp
    std/stardict_parser_std.cpp
    std/dictionary_manager_std.cpp
    std/fulltext_index_std.cpp
    std/mdict_parser_std.cpp
    std/dsl_parser_std.cpp
    std/csv_parser_std.cpp
)

target_include_directories(unidict_std_core PUBLIC
    "${CMAKE_CURRENT_SOURCE_DIR}"
    "${CMAKE_CURRENT_SOURCE_DIR}/std"
)

# 链接依赖
target_link_libraries(unidict_std_core
    PRIVATE ZLIB::ZLIB
    PUBLIC unidict_index_std
)

# 创建传统Qt兼容的核心库（如果需要）
if(Qt6_FOUND)
    add_library(unidict_core_qt STATIC
        mdict_parser.cpp
        stardict_parser.cpp
        json_parser.cpp
        data_store.cpp
        index_engine.cpp
        path_utils.cpp
        plugin_manager.cpp
        lookup_service.cpp
        unidict_core.cpp
    )

    target_include_directories(unidict_core_qt PUBLIC
        "${CMAKE_CURRENT_SOURCE_DIR}"
    )

    target_link_libraries(unidict_core_qt PUBLIC
        Qt6::Core
        unidict_std_core
    )
endif()

# 创建统一的核心库别名
add_library(UniDict::Core ALIAS unidict_std_core)
if(TARGET unidict_core_qt)
    add_library(UniDict::CoreQt ALIAS unidict_core_qt)
endif()

# 安装规则
install(TARGETS unidict_std_core unidict_index_std
    EXPORT UniDictCoreTargets
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    RUNTIME DESTINATION bin
)

if(TARGET unidict_core_qt)
    install(TARGETS unidict_core_qt
        EXPORT UniDictCoreTargets
        LIBRARY DESTINATION lib
        ARCHIVE DESTINATION lib
        RUNTIME DESTINATION bin
    )
endif()

# 安装头文件
install(DIRECTORY std/
    DESTINATION include/unidict/core/std
    FILES_MATCHING PATTERN "*.h"
)

install(FILES
    types.h
    unidict_core.h
    DESTINATION include/unidict/core
)

# 导出配置
install(EXPORT UniDictCoreTargets
    FILE UniDictCoreTargets.cmake
    NAMESPACE UniDict::
    DESTINATION lib/cmake/UniDictCore
)