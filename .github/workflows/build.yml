# GitHub Actions workflow for building the Unidict project
# This workflow is triggered on pushes and pull requests to the main branch.

name: Build Unidict

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    # The strategy matrix defines the different environments to run the job on.
    # We will run on the latest versions of Windows, macOS, and Ubuntu.
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    # The type of runner that the job will run on, based on the OS from the matrix.
    runs-on: ${{ matrix.os }}

    steps:
      # 1. Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it.
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Installs the specified version of Qt.
      # This is a crucial step that automates the Qt SDK setup on the runner.
      # The action exports a QT_ROOT_PATH environment variable for later steps.
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          # We use a specific, recent version of Qt for consistency across platforms.
          version: '6.5.3'
          # Use caching to speed up subsequent workflow runs.
          cache: true

      # 3. Configure the project using CMake.
      # We pass the path to the Qt installation via the CMAKE_PREFIX_PATH variable.
      # The QT_ROOT_PATH env var is provided by the install-qt-action step.
      - name: Configure CMake
        shell: bash
        run: cmake -B build -DCMAKE_PREFIX_PATH=${{ env.QT_ROOT_PATH }}

      # 4. Build the project using CMake.
      # The --build flag tells CMake to execute the build process.
      - name: Build Project
        shell: bash
        run: cmake --build build

      # 5. (Optional) A simple smoke test to ensure the CLI executable runs.
      # This verifies that the linkage against the core library was successful.
      - name: Run Smoke Test (CLI)
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./build/cli/Release/unidict_cli.exe hello
          else
            ./build/cli/unidict_cli hello
          fi
